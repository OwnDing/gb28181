# GB28181 轻量平台实施方案（Java 25 + Spring Boot 4 + Web + ZLMediaKit + SQLite）

## 1. 目标与边界

### 1.1 目标
- 实现登录页面
- 实现设备管理（注册、更新、删除）
- 实现在线预览（同时支持 H.264 / H.265）
- 实现录像存储策略（按天数、按总容量自动覆盖）
- 尽量轻量、依赖少、部署简单、支持多路并发

### 1.2 边界
- 后端主服务：`Java 25 + Spring Boot 4 + WebFlux`
- 媒体服务：`ZLMediaKit`
- 数据库：`SQLite`
- 前端：使用现有 `frontend` 项目（Vite + React）

## 2. 总体架构

```text
前端(React)
   |
   | HTTPS/WS
   v
Spring Boot(管理面 + GB28181信令 + 存储策略)
   |                     \
   | HTTP API            \ SIP(GB28181)
   v                      \
ZLMediaKit <--- RTP/PS --- 摄像头/NVR
   |
   | WebRTC/HLS/HTTP-FLV
   v
浏览器播放器
```

职责拆分：
- Spring Boot：账号、设备管理、信令控制、播放会话、录像策略、任务调度
- ZLMediaKit：收流、转协议、分发、录制、媒体状态回调
- SQLite：业务配置与元数据（设备、通道、录像索引、存储策略）

## 3. 是否需要 FFmpeg

结论：
- 你的组合 `Java + Spring Boot + ZLMediaKit` 可以跑起来。
- 但“浏览器端 H.265 全兼容”通常需要转码兜底，建议把 FFmpeg 作为可选增强依赖。

建议采用双模式：
- 纯轻量模式（默认）：无 FFmpeg，仅直通播放
  - H.264：广泛可播
  - H.265：仅在支持 HEVC 的浏览器/终端播放
- 兼容模式（推荐生产）：启用 FFmpeg 按需转码 H.265 -> H.264
  - 保障主流浏览器都可预览
  - 增加 CPU 消耗（需做并发限制）

## 4. 核心业务流程

## 4.1 设备注册与心跳
1. 在设备管理页新增设备：国标 ID、IP、端口、认证、传输模式（UDP/TCP）
2. 平台记录设备信息并发起注册授权
3. 设备周期性 `REGISTER/Keepalive`
4. 平台更新在线状态、最后心跳时间

## 4.2 实时预览流程
1. 前端点击“预览”
2. 后端检查设备在线并创建/复用流会话
3. 后端调用 ZLM `openRtpServer` 开端口
4. 后端发送 GB28181 `INVITE`（携带 RTP 目标地址和端口）
5. 设备向 ZLM 推送 RTP（PS 封装）
6. 前端请求播放地址：
   - 优先 WebRTC（低延时）
   - 回退 HLS / HTTP-FLV
7. 停播后引用计数减 1，为 0 则关闭会话和 RTP 端口

## 4.3 H.264 / H.265 在线播放策略

播放决策（后端 + 前端协同）：
1. 后端查询流编码（H.264 / H.265）
2. 若 H.264：直接返回 WebRTC 地址（首选）
3. 若 H.265：
   - 浏览器支持 HEVC：直通播放
   - 浏览器不支持 HEVC：
     - 若开启转码：启动转码子流（H.264）并返回子流地址
     - 若未开启转码：返回“当前浏览器不支持 H.265，请切换浏览器或开启转码”

前端能力检测建议：
- `MediaSource.isTypeSupported(...)` + User-Agent 规则联合判断
- 优先播放后端下发的最终地址，不在前端硬编码协议

## 4.4 录像与自动覆盖策略
1. 录像策略配置：
   - `retention_days`（保留天数）
   - `max_storage_gb`（最大容量）
   - `auto_overwrite`（超限自动删除最早录像）
2. 定时任务（建议每 1~5 分钟）：
   - 步骤 A：先删超过保留天数的录像
   - 步骤 B：计算目录总容量，若超 `max_storage_gb`，按时间升序删除最旧录像，直到低于阈值
3. 删除文件后同步更新数据库索引

## 5. 后端模块设计（建议包结构）

```text
src/main/java/com/ownding/video
  ├─ auth/                 # 登录、鉴权
  ├─ device/               # 设备、通道管理
  ├─ gb28181/              # SIP信令、消息构建、会话状态
  ├─ media/                # ZLM API封装、播放地址组装、转码控制
  ├─ record/               # 录像索引、目录扫描
  ├─ storage/              # 存储策略、清理任务
  ├─ common/               # 通用响应、异常、工具
  └─ config/               # 安全、数据库、线程池、配置项
```

关键点：
- `gb28181` 与 `media` 解耦，便于后续替换媒体引擎
- 所有 I/O（SIP、HTTP、文件扫描）异步化，避免阻塞 Netty 事件线程
- 对同一设备通道做“单飞”控制，避免重复 INVITE 打爆设备

## 6. 依赖建议（尽量少）

最小必需：
- `spring-boot-starter-webflux`
- `spring-boot-starter-security`
- `spring-boot-starter-validation`
- `spring-boot-starter-data-jdbc`（或 MyBatis，二选一）
- `org.xerial:sqlite-jdbc`
- `gov.nist:jain-sip-ri`（GB28181 SIP 信令）

可选：
- `flyway-core`（SQLite 初始化迁移）
- `micrometer + prometheus`（监控）
- `FFmpeg`（仅兼容模式需要，作为外部二进制，不强耦合到 Java 依赖）

## 7. SQLite 数据模型（建议）

```sql
CREATE TABLE user_account (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'ADMIN',
  enabled INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

CREATE TABLE gb_device (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  ip TEXT NOT NULL,
  port INTEGER NOT NULL,
  transport TEXT NOT NULL,               -- UDP/TCP
  username TEXT,
  password TEXT,
  media_ip TEXT,
  media_port INTEGER,
  online INTEGER NOT NULL DEFAULT 0,
  last_seen_at TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

CREATE TABLE gb_channel (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id INTEGER NOT NULL,
  channel_id TEXT NOT NULL,
  name TEXT,
  status TEXT NOT NULL DEFAULT 'OFFLINE',
  codec TEXT,                            -- H264/H265
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  UNIQUE(device_id, channel_id)
);

CREATE TABLE stream_session (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id INTEGER NOT NULL,
  channel_id TEXT NOT NULL,
  app TEXT NOT NULL,
  stream TEXT NOT NULL,
  codec TEXT,
  rtp_port INTEGER,
  viewer_count INTEGER NOT NULL DEFAULT 0,
  started_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  UNIQUE(device_id, channel_id)
);

CREATE TABLE storage_policy (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  retention_days INTEGER NOT NULL DEFAULT 7,
  max_storage_gb INTEGER NOT NULL DEFAULT 100,
  auto_overwrite INTEGER NOT NULL DEFAULT 1,
  record_enabled INTEGER NOT NULL DEFAULT 1,
  record_path TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

CREATE TABLE record_file (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id INTEGER NOT NULL,
  channel_id TEXT NOT NULL,
  file_path TEXT NOT NULL UNIQUE,
  file_size_bytes INTEGER NOT NULL,
  start_time TEXT,
  end_time TEXT,
  created_at TEXT NOT NULL
);
```

索引建议：
- `gb_device(device_id)`
- `gb_channel(device_id, channel_id)`
- `record_file(created_at)`
- `record_file(file_size_bytes)`

## 8. API 设计（第一版）

认证：
- `POST /api/auth/login`
- `POST /api/auth/logout`
- `GET /api/auth/me`

设备管理：
- `GET /api/devices`
- `POST /api/devices`
- `PUT /api/devices/{id}`
- `DELETE /api/devices/{id}`
- `GET /api/devices/{id}/channels`

预览控制：
- `POST /api/preview/start`（deviceId + channelId）
- `POST /api/preview/stop`
- `GET /api/preview/status`

录像与存储：
- `GET /api/storage/policy`
- `PUT /api/storage/policy`
- `GET /api/storage/usage`
- `GET /api/records`
- `DELETE /api/records/{id}`

## 9. 前端页面规划（对接现有 frontend）

页面：
- `/login` 登录页
- `/devices` 设备列表 + 新增/编辑/删除
- `/preview` 实时预览（多宫格）
- `/storage` 存储策略设置与容量看板

关键交互：
- 设备页：设备在线状态、最后心跳时间、通道数量
- 预览页：单路/多路播放，显示编码类型、协议类型、延时信息
- 存储页：保留天数、容量阈值、自动覆盖开关、当前用量

播放器策略：
- 优先 WebRTC，失败回退 HLS/HTTP-FLV
- H.265 流根据后端返回策略自动选择直通或转码流

## 10. ZLMediaKit 配置建议

建议部署：
- 与 Spring Boot 同机部署（个人使用最简单）
- Docker Compose 一键启动

建议关注参数：
- RTP 端口范围（避免冲突）
- 录像目录挂载到持久卷
- HTTP API 鉴权密钥
- 回调地址（流注册、流无人观看、录像完成）

典型端口（按实际环境调整）：
- SIP：`5060/udp`（平台信令）
- ZLM HTTP API：`8081`
- RTSP：`554`
- RTMP：`1935`
- HTTP-FLV/HLS：`80` 或自定义
- WebRTC：`rtc tcp/udp` 端口按 ZLM 配置放行

## 11. 性能与多路并发策略

1. 会话复用
- 同一通道只拉一份上行流
- 多个观看者共享下行分发，避免重复 INVITE

2. 限流与保护
- 设备维度并发上限
- 转码任务并发上限（如 `maxTranscodeJobs`）

3. 非阻塞处理
- WebFlux + 异步任务池
- 文件扫描与清理任务使用独立调度线程池

4. 数据库优化
- SQLite 开启 WAL
- 批量写入录像索引，减少锁竞争

5. 存储治理
- 录像文件分层目录（按设备/日期）
- 清理任务采用“分批删除”，避免长时间 I/O 抖动

## 12. 开发阶段建议

阶段 1（最小可用）
- 登录
- 设备 CRUD
- 单路预览（H.264）
- 存储策略保存

阶段 2（核心能力）
- GB28181 邀请/停播完整链路
- 多路预览 + 会话复用
- 录像索引与自动覆盖删除

阶段 3（兼容增强）
- H.265 能力识别
- 按需转码链路（可选 FFmpeg）
- 监控与告警（在线率、播放失败率、存储余量）

## 13. 关键风险与处理

1. H.265 浏览器兼容性不一致
- 处理：实现“可播能力探测 + 按需转码”双策略

2. 设备厂商实现差异（SIP/SDP）
- 处理：抽象设备适配层，记录厂商模板配置

3. 多路并发时 CPU/I/O 抖动
- 处理：优先直通、限制转码并发、分批清理文件

4. SQLite 并发写压力
- 处理：WAL + 批处理 + 降低无效写频率

## 14. 结论

该方案满足你提出的“轻量、少依赖、易部署、支持多路”的目标：
- 核心组合：`Java 25 + Spring Boot 4 + Web + ZLMediaKit + SQLite`
- 默认不强依赖 FFmpeg；仅在 H.265 全兼容诉求下按需启用
- 可以先以 MVP 快速上线，再逐步补齐兼容性与性能增强能力

